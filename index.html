<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q جي بي تي | النسخة النهائية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/tokyo-night-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
    
    <style>
        :root {
            --primary: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            --bg-dark: #0a0a0f;
            --chat-bg: #16213e;
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg-dark); color: white; margin: 0; display: flex; flex-direction: column; height: 100vh; }
        
        header { background: rgba(0,0,0,0.5); padding: 15px; text-align: center; border-bottom: 1px solid #333; backdrop-filter: blur(10px); }
        .logo { font-size: 24px; font-weight: bold; background: linear-gradient(90deg, #00d2ff, #92fe9d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 20px; }
        .msg { max-width: 80%; padding: 15px; border-radius: 15px; line-height: 1.6; position: relative; }
        .user-msg { background: var(--primary); align-self: flex-start; border-bottom-right-radius: 2px; }
        .ai-msg { background: var(--chat-bg); align-self: flex-end; border-bottom-left-radius: 2px; border: 1px solid #333; }
        
        /* تنسيق الأكواد داخل الردود */
        pre { background: #000 !important; padding: 10px; border-radius: 8px; overflow-x: auto; }
        code { font-family: 'Courier New', Courier, monospace; }

        .input-area { padding: 20px; background: #0f0c29; display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #1a1a2e; border: 1px solid #333; color: white; padding: 15px; border-radius: 10px; outline: none; }
        button { background: var(--primary); border: none; color: white; padding: 0 25px; border-radius: 10px; cursor: pointer; transition: 0.3s; }
        button:hover { opacity: 0.8; transform: translateY(-2px); }

        .typing { font-size: 12px; color: #00d2ff; margin-bottom: 10px; display: none; }
    </style>
</head>
<body>

<header>
    <div class="logo">Q جي بي تي</div>
</header>

<div id="chat-window">
    <div class="msg ai-msg">مرحباً قحطان! النسخة النهائية جاهزة. كيف يمكنني مساعدتك الآن؟</div>
</div>

<div class="input-area">
    <div id="status" class="typing">جاري التفكير...</div>
    <input type="text" id="userInput" placeholder="اسأل عن أي شيء...">
    <button id="sendBtn"><i class="fas fa-paper-plane"></i></button>
</div>

<script>
    const chatWindow = document.getElementById('chat-window');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');

    async function sendMessage() {
        const text = userInput.value.trim();
        if (!text) return;

        // إضافة رسالة المستخدم
        appendMessage(text, 'user');
        userInput.value = '';
        document.getElementById('status').style.display = 'block';

        try {
            const response = await fetch('/chat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });
            const data = await response.json();
            
            // تحويل Markdown إلى HTML وتلوين الأكواد
            appendMessage(data.reply, 'ai');
        } catch (e) {
            appendMessage("حدث خطأ في الاتصال بالخادم.", 'ai');
        } finally {
            document.getElementById('status').style.display = 'none';
        }
    }

    function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `msg ${sender}-msg`;
        
        if (sender === 'ai') {
            div.innerHTML = marked.parse(text); // تحويل التنسيق
            div.querySelectorAll('pre code').forEach((el) => {
                hljs.highlightElement(el); // تلوين الكود
            });
        } else {
            div.textContent = text;
        }
        
        chatWindow.appendChild(div);
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    userInput.onkeypress = (e) => { if(e.key === 'Enter') sendMessage(); };
</script>

</body>
</html>
